name: Semantic-PRLabel-Handler

on:
  workflow_call:
    inputs:
      json_versions:
        description: "The current versions JSON string"
        required: true
        type: string
    outputs:
      updated_json:
        description: "Updated JSON with bumped versions"
        value: ${{ jobs.bump-json-version.outputs.updated_json }}

jobs:
  bump-json-version:
    runs-on: ubuntu-latest
    outputs:
      updated_json: ${{ steps.bump_json.outputs.updated_json }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files between main and PR head
        #if: ${{ !inputs.components }}
        id: changes
        run: |
          git fetch origin ${{ github.event.pull_request.head.ref }}
          MERGE_BASE=$(git merge-base origin/main origin/${{ github.event.pull_request.head.ref }})
          FILES=$(git diff --name-only "$MERGE_BASE" origin/${{ github.event.pull_request.head.ref }})

          echo "$FILES"
          {
            echo 'files<<EOF'
            echo "$FILES"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      #- name: Extract changed components
        #if: ${{ !inputs.components }}
        #id: components
        #run: |    
          #FILES="${{ steps.changes.outputs.files }}"
          #COMPONENTS_FROM_YML=$(echo "$FILES" | grep -oP 'ci-\K[^.]+(?=\.yml)' || true)
          #COMPONENTS_FROM_DIR=$(echo "$FILES" | awk -F/ '$1 != ".github" { print $1 }' | sort -u || true)

          #COMPONENTS=$(echo -e "$COMPONENTS_FROM_YML\n$COMPONENTS_FROM_DIR" | sort -u | tr '\n' ' ')
          #COMPONENTS=$(echo "$FILES" | grep -oP 'ci-\K[^.]+(?=\.yml)' | sort -u | tr '\n' ' ')
          #if [[ -z "$COMPONENTS" ]]; then
            #echo "No components changed. Exiting."
            #exit 1
          #fi
          
          #echo "âœ… Detected components: $COMPONENTS"
          # Outputs
          #echo "components=$COMPONENTS" >> "$GITHUB_OUTPUT"
          
      - name: Extract changed components
        #if: ${{ !inputs.components }}
        id: components
        shell: bash
        run: |
          FILES="${{ steps.changes.outputs.files }}"
          COMPONENTS_FROM_YML=$(echo "$FILES" | grep -oP 'ci-\K[^.]+(?=\.yml)' || true)
          COMPONENTS_FROM_DIR=$(echo "$FILES" | awk -F/ '$1 != ".github" { print $1 }' | sort -u || true)

          COMPONENTS=$(echo -e "$COMPONENTS_FROM_YML\n$COMPONENTS_FROM_DIR" | sort -u | tr '\n' ' ')

          # --- New logic for backend components from backend-components.json ---
          # Filter backend files only
          BACKEND_FILES=$(echo "$FILES" | grep '^backend/' || true)
    
          if [ -n "$BACKEND_FILES" ]; then
             COMPONENTS_JSON="backend-components.json"
             declare -A MATCHED_BACKEND_COMPONENTS=()
      
             while IFS= read -r file; do
                component_title=$(jq -r --arg path "$file" '
                  .[] | select($path | startswith("backend/" + .srcPath)) | .title
                ' "$COMPONENTS_JSON")
        
                if [ -n "$component_title" ]; then
                  MATCHED_BACKEND_COMPONENTS["$component_title"]=1
                fi
             done <<< "$BACKEND_FILES"
      
             BACKEND_COMPONENTS=$(printf "%s\n" "${!MATCHED_BACKEND_COMPONENTS[@]}" | sort | tr '\n' ' ')
      
             # Append backend components to COMPONENTS if any found
             if [ -n "$BACKEND_COMPONENTS" ]; then
               COMPONENTS="$COMPONENTS $BACKEND_COMPONENTS"
             fi
          fi

          COMPONENTS=$(echo "$COMPONENTS" | xargs -n1 | sort -u | tr '\n' ' ')

          if [[ -z "$COMPONENTS" ]]; then
            echo "No components changed. Exiting."
            exit 1
          fi

          echo "âœ… Detected components: $COMPONENTS"
          echo "components=$COMPONENTS" >> "$GITHUB_OUTPUT"  
          
      - name: Parse bump type from PR labels
        if: github.event_name == 'pull_request'
        id: bump
        #env:
           #LABELS_JSON: ${{ toJson(github.event.pull_request.labels) }}
        run: |
         echo "Extracting labels..."
         LABELS_JSON='${{ toJson(github.event.pull_request.labels) }}'
         echo "$LABELS_JSON"

         LABELS=$(jq -r '.[].name' <<< "$LABELS_JSON")
         echo "Labels found: $LABELS"

          TYPE=""
          if echo "$LABELS" | grep -q "semver:major"; then
            TYPE="major"
          elif echo "$LABELS" | grep -q "semver:minor"; then
            TYPE="minor"
          elif echo "$LABELS" | grep -q "semver:patch"; then
            TYPE="patch"
          else
            echo "âŒ No valid semver label (semver:major|minor|patch) found."
            exit 1
          fi

          echo "âœ… Bump type: $TYPE"
          echo "type=$TYPE" >> "$GITHUB_OUTPUT"
       
      - name: Bump version in JSON
        id: bump_json
        run: |
          COMPONENTS="${{ steps.components.outputs.components }}"
          BUMP_TYPE="${{ steps.bump.outputs.type }}"
          echo '${{ inputs.json_versions }}' > versions.json
          jq '.' versions.json > tmp.json

          for COMP in $COMPONENTS; do
            CURRENT=$(jq -r --arg c "$COMP" '.[$c]' tmp.json)
            if [ "$CURRENT" == "null" ]; then
              echo "Component $COMP not found. Skipping."
              continue
            fi

            IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

            case "$BUMP_TYPE" in
              major) ((MAJOR+=1)); MINOR=0; PATCH=0 ;;
              minor) ((MINOR+=1)); PATCH=0 ;;
              patch) ((PATCH+=1)) ;;
            esac

            NEW="$MAJOR.$MINOR.$PATCH"
            echo "ðŸ”§ $COMP bumped to $NEW"
            tmpfile=$(mktemp)
            jq --arg c "$COMP" --arg v "$NEW" '.[$c]=$v' tmp.json > "$tmpfile" && mv "$tmpfile" tmp.json
          done

          FINAL_JSON=$(jq -c . < tmp.json)
          echo "âœ… Final bumped JSON: $FINAL_JSON"
          echo "updated_json=$FINAL_JSON" >> "$GITHUB_OUTPUT"
